<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/todoList.css" />
    <link rel="stylesheet" href="/css/navbar.css" />

    <title>Todo List</title>
  </head>
  <body>
    <%- include('../partials/navbar.ejs') %>

    <div class="todo-container">
      <h2>Todo List</h2>

      <!-- Filters -->
      <form action="/" class="filters" method="GET">
        <input type="text" id="search" name="search" placeholder="Search by name..." />
        <select id="status" name="status">
          <option value="">All</option>
          <option value="done">Done</option>
          <option value="pending">Pending</option>
        </select>
        <input type="date" id="dateFilter" name="dateFilter"/>
        <button type="submit">Filter</button>
      <button id="openModal" class="add-todo-btn" type="button">+ Add Todo</button>

    </form>
    <!-- Error message -->
   <% if (typeof message !== "undefined") { %>
        <p class="notification <%= hasError ? 'error' : 'success' %>"><%= message %></p>
    <% } %>
      <!-- Date Section -->
      <% if(typeof todoList !== "undefined" && Object.keys(todoList).length > 0) { %>
        <% Object.entries(todoList || {}).forEach(([date,todos])=>{ %>
            <% const isCompleted = (todos||[]).every((item)=>item.completed) %>
        <div class="date-section">
            <div class="date-header"
            <% if(isCompleted) { %>
                style="background: hsla(120, 100%, 30%,0.3); color: hsl(120, 100%, 25%);"
            <% } %>>
            <span> <%= date %> </span>
            <span class="arrow">â–¶</span>
            </div>
            <div class="task-list">
            <% todos.forEach((todo)=>{%>
            <div class="task <%= todo?.completed ? 'done' : '' %>">
                <div class="task-left">
                    <!-- Checkbox  -->
                <input
                    type="checkbox"
                    data-id="<%= todo?._id %>"
                    <% if (todo?.completed) { %>
                        style="cursor: not-allowed"
                    <% } %>
                    style="<%= todo?.completed ? 'cursor: not-allowed' : '' %>"
                    <%= todo?.completed ? 'checked disabled' : '' %>
                    class="done-checkbox"
                />
                <!--Checkbox end -->

                <span><%= todo?.title %></span>
                </div>
                <% if(todo?.completed){%>
                <small class="completed-time"
                >Completed on <%= todo?.completedAt %></small
                >
                <%} %>
            </div>
            <% }) %>
            </div>
        </div>
        <% })%>
      <% } %>
      <!-- Modal -->
        <div id="todoModal" class="modal">
            <div class="modal-content">
                <span id="closeModal" class="close">&times;</span>
                <h3>Add a New Todo</h3>
                <form id="addTodoForm" method="POST" action="/">
                    <div class="form-input">
                        <label for="title">Todo Title</label>
                        <input type="text" id="title" name="title" placeholder="Enter Todo title" required />
                    </div>
                    <div class="form-input">
                        <label for="date">Todo Date</label>
                        <input type="date" id="date" name="date" placeholder="Todo date" required />
                    </div>
                <button type="submit">Save</button>
                </form>
            </div>
        </div>
    </div>

    <script>
      // Collapse/Expand functionality
      document.querySelectorAll(".date-header").forEach((header) => {
        header.addEventListener("click", () => {
          const taskList = header.nextElementSibling;
          const arrow = header.querySelector(".arrow");

          taskList.style.display =
            taskList.style.display === "block" ? "none" : "block";

          arrow.classList.toggle("rotate");
        });
      });

      // Checkbox mark as done + completion time with confirmation
      document.querySelectorAll(".done-checkbox").forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            const confirmDone = confirm("Mark this task as completed?");
            if (!confirmDone) {
              checkbox.checked = false; // revert
              return;
            }
        const taskId = checkbox.dataset.id;
        console.log(taskId, "marked as done");
          }
        });
      });

            // Modal open/close
        const modal = document.getElementById("todoModal");
        const openBtn = document.getElementById("openModal");
        const closeBtn = document.getElementById("closeModal");

        openBtn.addEventListener("click", () => modal.style.display = "block");
        closeBtn.addEventListener("click", () => modal.style.display = "none");
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });
    </script> 
  </body>
</html>
